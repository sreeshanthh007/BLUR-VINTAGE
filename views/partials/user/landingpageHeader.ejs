<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLUR VINTAGE ★</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/styles/landingpage.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
            .search-result-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .search-result-item:hover {
        background-color: #f8f9fa;
    }

    .search-result-item img {
        width: 40px;
        height: 40px;
        object-fit: cover;
    }

    .search-result-info {
        flex: 1;
    }

    .search-result-name {
        font-weight: 500;
        margin-bottom: 2px;
    }

    .search-result-price {
        color: #666;
        font-size: 0.9em;
    }   
       .search-result-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .search-result-item:hover {
        background-color: #f8f9fa;
    }

    .search-result-item img {
        width: 40px;
        height: 40px;
        object-fit: cover;
    }

    .search-result-info {
        flex: 1;
    }

    .search-result-name {
        font-weight: 500;
        margin-bottom: 2px;
    }

    .search-result-price {
        color: #666;
        font-size: 0.9em;
    }

    .form-select-sm {
        padding-right: 2rem;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 0.875rem;
    }

    .form-select-sm:focus {
        border-color: black;
        box-shadow: none;
    }    
    @media (max-width: 768px) {
            .search-container {
                max-width: 100%;
            }

            .nav-menu a {
                padding: 0.5rem 1rem;
                font-size: 1rem;
            }

            .icon-link {
                margin-left: 1rem;
                font-size: 1.25rem;
            }
        }
        </style>
    </head>

    <!-- header starts -->
    <body>
        <header class="py-3 bg-light">
            <div class="container">
                <div class="row align-items-center">
                    <!-- Left Section -->
                    <div class="col-4 d-flex align-items-center justify-content-start">
                        <a href="#" class="text-dark me-3 text-decoration-none">Contact Us</a>
                    </div>
        
                    <!-- Center Section -->
                    <div class="col-4 text-center">
                        <a class="m-0" style="font-family: 'Joan';font-size: 25px; text-decoration: none; color: black;" href="/user/home">BLUR VINTAGE ★</a>
                    </div>
        
                    <!-- Right Section -->
                    <div class="col-lg-3 col-md-4">
                        <div class="d-flex align-items-center justify-content-end">
                            <form class="d-flex me-3 position-relative">
                                <input 
                                    class="form-control form-control-sm me-2" 
                                    type="search" 
                                    placeholder="Search products..." 
                                    aria-label="Search" 
                                    id="searchInput"
                                    autocomplete="off"
                                    value="<%=search || ''%>"
                                >
                                <button class="btn btn-outline-dark btn-md" type="submit">
                                    <i class="bi bi-search"></i>
                                </button>
                                <!-- Add this div for search results -->
                                <div id="searchResults" class="position-absolute w-100 bg-white shadow-sm rounded-bottom" 
                                    style="top: 100%; left: 0; z-index: 1000; display: none; max-height: 400px; overflow-y: auto;">
                                </div>
                            </form> 
                            <a class="bi bi-person me-3" style="font-size: 1.5rem; color: black;" href="/user/manage"></a>
                            <div class="position-relative me-3">
                                <a class="bi bi-cart" href="/user/cart" style="font-size: 1.5rem; color: black;"></a>
                                <span id="cartCounter" class="position-absolute top-0  start-100 translate-middle badge rounded-pill bg-danger" 
                                      style="font-size: 0.75rem; margin-top: 5px;">
                                    0
                                </span>
                            </div>
                           
                            <a class="bi bi-heart" style="font-size: 1.5rem; color: black;"  href="/user/wishlist"></a>
                          </a>
                        </div>
                    </div>
                </div>
        
                <!-- Men, Women, Kids Navigation -->
                <div class="row mt-3">
                    <div class="col-12 text-center">
                        <nav class="nav justify-content-center">
                            <a class="nav-link mx-4 text-dark" href="/user/shop" style="font-size: 1.2rem;">Shop</a>
                            <a class="nav-link mx-4 text-dark" href="/user/men" style="font-size: 1.2rem;">Men</a>
                            <a class="nav-link mx-4 text-dark" href="/user/women" style="font-size: 1.2rem;">Women</a>
                            <a class="nav-link mx-4 text-dark" href="/user/kids" style="font-size: 1.2rem;">Kids</a>
                        </nav>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12 d-flex justify-content-end pe-4">
                        <select id="sortSelect" class="form-select form-select-sm" style="width: auto;">
                            <option value="default" disabled selected>Sort By</option>
                            <option value="price-high-low">Price: High to Low</option>
                            <option value="price-low-high">Price: Low to High</option>
                            <option value="name-a-z">Name: A to Z</option>
                            <option value="name-z-a">Name: Z to A</option>
                            <option value="new-arrivals">New Arrivals</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>
        <!-- header ends -->


        <script>


document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const sortSelect = document.getElementById('sortSelect');
    const searchButton = document.querySelector('.btn-outline-dark');
    let debounceTimer;

    // Function to get current category from URL
    function getCurrentCategory() {
        const path = window.location.pathname;
        if (path.includes('/men')) return 'men';
        if (path.includes('/women')) return 'women';
        if (path.includes('/kids')) return 'kids';
        return '';
    }

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

   
    function highlightMatch(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
        return text.replace(regex, '<strong>$1</strong>');
    }

    async function searchProducts(query) {
    try {
        const currentPath = window.location.pathname;
        const sortValue = sortSelect ? sortSelect.value : 'default';
        
        // Create URLSearchParams object for cleaner URL construction
        const searchParams = new URLSearchParams();
        
        // Add search query if it exists
        if (query.trim()) {
            searchParams.set('search', query);
        }
        
      
        if (sortValue !== 'default') {
            searchParams.set('sort', sortValue);
        }
        
        // Set category and page context based on current path
        if (currentPath.includes('/shop')) {
            searchParams.set('page_context', 'shop');
        } else if (currentPath.includes('/men')) {
            searchParams.set('category', 'men');
        } else if (currentPath.includes('/women')) {
            searchParams.set('category', 'women');
        } else if (currentPath.includes('/kids')) {
            searchParams.set('category', 'kids');
        }
        
        // Navigate to the search URL with all parameters
        window.location.href = `/user/search?${searchParams.toString()}`;
    } catch (error) {
        console.error('Search error:', error);
    }
}

// Update the suggestion fetch as well
searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim();
    const currentPath = window.location.pathname;
    
    if (query.length >= 2) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            try {
                // Build search params for suggestions
                const searchParams = new URLSearchParams({
                    search: query,
                    suggest: 'true'
                });
                
                // Add appropriate context
                if (currentPath.includes('/shop')) {
                    searchParams.set('page_context', 'shop');
                } else {
                    const currentCategory = getCurrentCategory();
                    if (currentCategory) {
                        searchParams.set('category', currentCategory);
                    }
                }

                const response = await fetch(`/user/search?${searchParams.toString()}`);
                const data = await response.json();

                if (data.products && data.products.length > 0) {
                    const resultsHtml = data.products.map(product => `
                        <div class="search-result-item" onclick="window.location.href='/user/buy?id=${product._id}'">
                            <img src="${product.variants[0]?.productImage[0] || '/images/default-product.jpg'}" 
                                alt="${product.productName}">
                            <div class="search-result-info">
                                <div class="search-result-name">
                                    ${highlightMatch(product.productName, query)}
                                </div>
                                <div class="search-result-price">
                                    Rs/-${product.variants[0]?.price || 'Price not available'}
                                </div>
                            </div>
                        </div>
                    `).join('');

                    searchResults.innerHTML = resultsHtml;
                    searchResults.style.display = 'block';
                } else {
                    searchResults.innerHTML = '<div class="p-3 text-center text-muted">No products found</div>';
                    searchResults.style.display = 'block';
                }
            } catch (error) {
                console.error('Suggestion error:', error);
            }
        }, 300);
    } else {
        searchResults.style.display = 'none';
    }   
});

    // Handle form submission
    searchInput.closest('form').addEventListener('submit', (e) => {
        e.preventDefault();
        const query = searchInput.value.trim();
        searchProducts(query);
    });

    searchButton.addEventListener('click', (e) => {
        e.preventDefault();
        const query = searchInput.value.trim();
        searchProducts(query);
    })
   
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });

    
if (sortSelect) {
    sortSelect.addEventListener('change', function() {
        const currentUrl = new URL(window.location.href);
        const searchParams = new URLSearchParams(currentUrl.search);
        
        
        searchParams.set('sort', this.value);
        
       
        if (window.location.pathname.includes('/shop')) {
            searchParams.set('page_context', 'shop');
        }
        
  
        const searchQuery = document.getElementById('searchInput').value.trim();
        if (searchQuery) {
            searchParams.set('search', searchQuery);
        }
        
        // Navigate to new URL with all parameters
        window.location.href = `${currentUrl.pathname}?${searchParams.toString()}`;
    });
}
});

   async function updateCartCounter(){
    try {
        const response  = await fetch('/user/cart/count');
        if (!response.ok) {
            throw new Error('Failed to fetch cart count');
        }

        const data = await response.json();

        const counter = document.getElementById('cartCounter');

        if(counter){
            counter.textContent = data.count || '0';

            counter.style.display = data.count >0 ? "block" : "none";
        }


    } catch (error) {
        console.log("error in cart counter",error.message);
        
    }
   }

   document.addEventListener('DOMContentLoaded', updateCartCounter);

// Modify your existing addToCart event listener
const addToCartButton = document.getElementById("addToCart");
if (addToCartButton) {
    const existingClickHandler = addToCartButton.onclick;
    addToCartButton.onclick = async function(e) {
        if (existingClickHandler) {
            await existingClickHandler.call(this, e);
        }
        // Update cart counter after adding item
        updateCartCounter();
    };
}
    </script>